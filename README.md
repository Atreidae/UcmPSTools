# UcmPSTools

## Build Status

[![Build Status](https://dev.azure.com/UcMadScientist/UcmPSTools/_apis/build/status/Atreidae.UcmPSTools?branchName=main)](https://dev.azure.com/UcMadScientist/UcmPSTools/_build/latest?definitionId=1&branchName=main)

## Tests

## About UcmPSTools

 UcmPSTools is a collection of PowerShell functions to ease the administration of Microsoft Teams Unified Communications features and its related services.
 If you're a Teams Voice engineer or are transitioning from Skype for Business to Teams, you should find alot of these functions useful.

 This initially started out as a scratch pad for my commonly used UC related functions. I took it as an oppertunity to centralize alot of the code I use in my day to day work.
 Instead of just building things bespoke for me, I decided to clean all the functions up, heavily document them and release them on the PowerShell Gallery

 Detailed posts for each function will come soon, but for now you can find inline PowerShell help and documentation to get you started.

## Reporting Output

 Most of the functions in this module will return a PSCustomObject indicating the success or failure of each function and some descriptive text along with it.
 Detailed descriptions of each functions output can be found in the comment based help in each function.

 $Return.Status usually returns one of four values
 "OK"      : The operation was sucsessful, nothing of concern
 "Warn"    : The operation was sucsessful, but there is something you should be mindful of (We are trying to create a user that already exists, or we are running low on licences to assign). More information will be found in $Return.Message
 "Error"   : The operation was unsucsessful, Something happend when attempting to perform the operation that we couldnt handle, check $Return.Message for more information
 "Unknown" : Cmdlet reached the end of the fucntion without returning anything, this shouldnt happen, if it does please log an issue on Github with your relevant log files.

 $Return.Message returns descriptive text showing the connected tenant, mainly for logging, reporting or diagnosis.

 If the function you are calling is working with multiple objects, then an array will be returned with multiple objects idenified by their unique attribute, such as SIP Address.
 (presently, no function does this, but I am planning on multiple object support for many cmdlets. See the private for more.)

## Security Information

As this module frequently runs automated automations, it has been designed to hold on to creds and tokens as long as it can. 
As such great care should be taken to ensure that the scripts are unmodified before using them. Either download this directly from my GitHub Repo <https://github.com/atreidae/ucmpstools> or from the PowerShell Gallery ##todo## License

### A Note on Creds.xml

The creds.xml file is generated by any of the New-*Connection cmdlets and allows for autoreconnection should a session drop mid user migration
This file is encrypted with a per user encryption key provided by Windows.
These files are not portable and cannot be moved from one machine to another, or one user profile to another.

Whilst a Creds.xml is encrypted. It should be looked after like a certificate, should your user profile be compromised it is possible for someone to write a script and execute it in your profile to retrieve the stored credentials.

## List of Functions (Public)

### Office365 Connection Related

Functions for checking and connecting to relevant Office365 services

#### New-MSOLConnection

Clears any existing MSOL Connections and connects to MSOL, if user credentials arent presently stored in memory, the function checks for a creds.xml file in the local folder and loads it into memory.
Should the Creds.xml not be found, it will prompt the user to provide credentials and write a new creds.xml in the current folder.

#### New-SFBOConnection

Clears any existing MSOL Connections and connects to MSOL, if user creds arent in memory, the function checks for a creds.xml file in the local folder and loads it into memory.
Should the Creds.xml not be found, it will prompt the user to provide credentials and write a new creds.xml in the current folder.

#### New-EXHOConnection

Note: this function presently uses the old community Exchange module. I am in the process of re-writing it to support the Exchange Online 2.0 module

### Test-MSOLConnection

This function will test if the current PowerShell Session is connected to Office 365 Azure AD (Using Azure AD v1) and that the PSSession isnt broken
If its not connected for any reason, it will return an error

### Test-SFBOConnection

This function will test if the current PowerShell Session is connected to Skype for Business Online via either the Skype4B module or the MicrosoftTeams module and that the PSSession isnt broken
If its not connected for any reason, it will then invoke New-SFBOConnection to reconnect

### Test-EXHOConnection

This function will test if the current PowerShell Session is connected to Exchange Online and that the PSSession isnt broken
If its not connected for any reason, it will then invoke New-EXHOConnection to reconnect

### User Management Related

Functions for creating, licencing and enabling users

#### Todo

### Call Management Related

Functions related to the creation and management of Call Queues, Auto Attendants, Holidays etc.

#### Todo 2

### PSTN Number Management Related

Functions relating to the assignment, management and checking of PSTN Numbers.

#### Todo 3

### Reporting related

Functions for logging and creation of reports to automated proceedures.

## List of Functions (Private)

This section covers functions that havent made it to the public folder yet, the documentation may be incorrect, incomplete or just may not exist.
Use at your own risk

### New-CsFixedNumberDiversion-pipelinework (Broken)

Multi input variant of New-CsFixedNumberDiversion, presently broken

### Create-OnPremAdAccount

Quickly bashed together fucntion to create on prem accounts, used for creating objects for direct routing AutoAttendants

### Find-UcmCsLineUri (broken)

Copy of an old line URI finder I wrote based of some of Tom ARbuthnots code.
Needs to be updated for Teams

### Invoke-UcmBatchSfb2TeamsMove (Broken)

Development for moving users from Onprem Skype for Business to Microsoft Teams


## Developing for this module

Everything from this point down is just for those looking to get into the nitty gritty of the code, and isnt required to use the module.

If you intend to use the functions in this GitRepo seperate from the PowerShell functions I should explain a few of the caveats
A handy tip for anyone working on this, or trying to use it seperate from the published module is the "Test-ImportFunctions.ps1" script.
This script will attempt to load all the functions found in the public folder into your current PowerShell session. Simply "Dot Source" it to make all the functions available outside of the script scope.

```PowerShell
. C:\UcMadScientist\PowerShell-Functions\Test-ImportFunctions.ps1
```

You can also add the "private" flag to the script to import any functions in the private folder.

```PowerShell
. C:\UcMadScientist\PowerShell-Functions\Test-ImportFunctions.ps1 -Private
```

## Folder structure

### public

This is where most of the functions reside, each function or closely related functions (the reporting ones for example) reside in their own PS1 file to simplify change management as well as reducing testing effort during changes.

Any PS1 files in this folder require associated pester tests and will be signed with my certificate. before being packaged up into the module and shipped to the PowerShell Gallery. Understandably, I take commits to this folder quite seriously before they make it into the main branch.

### build_scripts

This folder contains code that will be executed by my Azure Pipeline instance.
It's responsible for running Pester Tests, Signing the functions, and packaging the module.

Thanks to Adam the Automater for these wicked pipeline tools
Check out <https://adamtheautomator.com/powershell-devops/> for more info!
Plus Nicola Suter's guide to signing PowerShell scripts using Aure Pipelines <https://tech.nicolonsky.ch/sign-powershell-az-devops/>
and COLIN DEMBOVSKY's guide to Azure Pipeline Variables <https://colinsalmcorner.com/azure-pipeline-variables/>

### private

Functions, scripts or modules included in the private folder will not be signed or tested by pester.
This is where I usually put functions I'm working on or testing, so may not work at all.
These functions will **not** be included in the automatically generated PowerShell module for publishing to the PowerShell Gallery.
